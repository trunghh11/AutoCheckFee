<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool T√≠nh Doanh Thu Shopee (Chi Ti·∫øt Thu·∫ø)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #ee4d2d; 
            margin-bottom: 25px;
        }
        .description {
            background-color: #e8f0fe;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.95em;
            line-height: 1.5;
        }
        /* ·∫®n input m·∫∑c ƒë·ªãnh */
        input[type="file"] {
            display: none;
        }
        
        .upload-area {
            border: 2px dashed #bdc3c7;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }
        .upload-area:hover {
            border-color: #ee4d2d;
            background-color: #fff5f2;
        }
        .btn-upload {
            background-color: #ee4d2d;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
            pointer-events: none; /* Ch·∫∑n click ƒë√∫p */
        }
        #output {
            margin-top: 30px;
        }
        
        /* Card Style */
        .card {
            background: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .card-header {
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
            border-bottom: 1px solid #e1e4e8;
        }
        .summary-card {
            border: 2px solid #2196F3;
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.15);
        }
        .summary-card .card-header {
            background-color: #e3f2fd;
            color: #0d47a1;
            font-size: 1.25em;
            text-transform: uppercase;
        }
        .card-body {
            padding: 15px 20px;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        .metric-row:last-child {
            border-bottom: none;
        }
        .metric-value {
            font-family: "Consolas", "Monaco", monospace;
            font-weight: bold;
            font-size: 1.05em;
        }
        
        .val-revenue { color: #2196F3; } 
        .val-refund { color: #F44336; }  
        .val-settlement { color: #4CAF50; } 
        .val-platform { color: #FF9800; }   
        
        .error-msg {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
            text-align: center;
        }
        .section-title {
            margin: 30px 0 15px;
            font-weight: bold;
            color: #666;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>C√¥ng C·ª• T√≠nh To√°n Doanh Thu Shopee</h1>
    
    <div class="description">
        <strong>H∆∞·ªõng d·∫´n:</strong> T·∫£i file <em>Income...xlsx</em> t·ª´ Shopee, upload v√†o √¥ d∆∞·ªõi. <br>
        Tool s·∫Ω t·ª± l·ªçc ƒë∆°n "Order" v√† t√≠nh to√°n chi ti·∫øt t·ª´ng lo·∫°i thu·∫ø.
    </div>

    <div class="upload-area" id="drop-zone">
        <div style="font-size: 40px; margin-bottom: 10px;">üìÇ</div>
        <p style="margin: 0; font-weight: 500;">K√©o th·∫£ file Excel v√†o ƒë√¢y</p>
        <p style="margin: 5px 0 15px; color: #888; font-size: 0.9em;">ho·∫∑c nh·∫•n n√∫t b√™n d∆∞·ªõi</p>
        <label class="btn-upload">Ch·ªçn File B√°o C√°o</label>
        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
    </div>

    <div id="error-msg" class="error-msg"></div>
    <div id="output"></div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const outputDiv = document.getElementById('output');
    const errorDiv = document.getElementById('error-msg');
    const dropZone = document.getElementById('drop-zone');

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    };

    const processFile = (file) => {
        outputDiv.innerHTML = '<p style="text-align:center; color:#666;">‚è≥ ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</p>';
        errorDiv.style.display = 'none';

        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes("doanh thu"));
                if (!sheetName) sheetName = workbook.SheetNames[0];

                const worksheet = workbook.Sheets[sheetName];
                const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                let headerRowIndex = -1;
                for (let i = 0; i < Math.min(rawData.length, 50); i++) {
                    const rowStr = JSON.stringify(rawData[i]);
                    if (rowStr && rowStr.includes("M√£ giao d·ªãch") && rowStr.includes("Ng√†y ƒë·∫∑t h√†ng")) {
                        headerRowIndex = i;
                        break;
                    }
                }

                if (headerRowIndex === -1) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y d√≤ng ti√™u ƒë·ªÅ h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra file.");
                }

                const jsonData = XLSX.utils.sheet_to_json(worksheet, { range: headerRowIndex });

                // Kh·ªüi t·∫°o bi·∫øn
                const results = {};
                const grandTotal = {
                    refundAmount: 0,
                    settlementRevenue: 0,
                    totalSettlement: 0,
                    affiliateFee: 0,
                    taxGTGT: 0, // T√°ch thu·∫ø GTGT
                    taxTNCN: 0  // T√°ch thu·∫ø TNCN
                };

                jsonData.forEach(row => {
                    let orderType = row["ƒê∆°n h√†ng / S·∫£n ph·∫©m"];
                    if (orderType !== "Order") return;

                    let dateVal = row["Ng√†y ƒë·∫∑t h√†ng"]; 
                    if (!dateVal) return;

                    let dateObj;
                    if (typeof dateVal === 'number') {
                         dateObj = XLSX.SSF.parse_date_code(dateVal);
                         dateObj = new Date(dateObj.y, dateObj.m - 1, dateObj.d);
                    } else {
                        dateObj = new Date(dateVal);
                    }
                    
                    if (isNaN(dateObj.getTime())) return;

                    const monthKey = `Th√°ng ${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;

                    if (!results[monthKey]) {
                        results[monthKey] = {
                            refundAmount: 0, 
                            settlementRevenue: 0, 
                            totalSettlement: 0, 
                            affiliateFee: 0, 
                            taxGTGT: 0, 
                            taxTNCN: 0 
                        };
                    }

                    const getNum = (key) => {
                        let val = row[key];
                        if (typeof val === 'number') return val;
                        if (typeof val === 'string') {
                            val = parseFloat(val.replace(/,/g, ''));
                            return isNaN(val) ? 0 : val;
                        }
                        return 0;
                    };

                    // --- T√çNH TO√ÅN ---
                    const valHoanLai = getNum("S·ªë ti·ªÅn ho√†n l·∫°i");
                    const refundVal = valHoanLai < 0 ? valHoanLai : 0;

                    const valGiaSP = getNum("Gi√° s·∫£n ph·∫©m");
                    const valVoucherNB = getNum("M√£ ∆∞u ƒë√£i do Ng∆∞·ªùi B√°n ch·ªãu");
                    const valVoucherDongTaiTro = getNum("M√£ ∆∞u ƒë√£i ƒê·ªìng T√†i Tr·ª£ do Ng∆∞·ªùi B√°n ch·ªãu");
                    const valXuNB = getNum("M√£ ho√†n xu do Ng∆∞·ªùi B√°n ch·ªãu");
                    const valXuDongTaiTro = getNum("M√£ ho√†n xu ƒê·ªìng T√†i Tr·ª£ do Ng∆∞·ªùi B√°n ch·ªãu");
                    const currentRev = valGiaSP + valHoanLai + valVoucherNB + valVoucherDongTaiTro + valXuNB + valXuDongTaiTro;

                    const currentSettlement = getNum("T·ªïng ti·ªÅn ƒë√£ thanh to√°n");
                    const currentAffiliate = getNum("Ph√≠ hoa h·ªìng Ti·∫øp th·ªã li√™n k·∫øt");
                    
                    // T√°ch ri√™ng thu·∫ø
                    const currentTaxGTGT = getNum("Thu·∫ø GTGT");
                    const currentTaxTNCN = getNum("Thu·∫ø TNCN");

                    // C·ªông v√†o Th√°ng
                    results[monthKey].refundAmount += refundVal;
                    results[monthKey].settlementRevenue += currentRev;
                    results[monthKey].totalSettlement += currentSettlement;
                    results[monthKey].affiliateFee += currentAffiliate;
                    results[monthKey].taxGTGT += currentTaxGTGT;
                    results[monthKey].taxTNCN += currentTaxTNCN;

                    // C·ªông v√†o T·ªïng H·ª£p
                    grandTotal.refundAmount += refundVal;
                    grandTotal.settlementRevenue += currentRev;
                    grandTotal.totalSettlement += currentSettlement;
                    grandTotal.affiliateFee += currentAffiliate;
                    grandTotal.taxGTGT += currentTaxGTGT;
                    grandTotal.taxTNCN += currentTaxTNCN;
                });

                renderResults(results, grandTotal);

            } catch (err) {
                console.error(err);
                errorDiv.innerText = "L·ªói: " + err.message;
                errorDiv.style.display = 'block';
                outputDiv.innerHTML = '';
            }
        };

        reader.readAsArrayBuffer(file);
    };

    const renderResults = (results, grandTotal) => {
        let html = '';

        // --- Render Ph·∫ßn T·ªïng H·ª£p ---
        // CT: Doanh thu - S·ªë ti·ªÅn quy·∫øt to√°n + Ph√≠ Affiliate + Thu·∫ø GTGT + Thu·∫ø TNCN
        const grandPlatformFee = grandTotal.settlementRevenue - grandTotal.totalSettlement + grandTotal.affiliateFee + grandTotal.taxGTGT + grandTotal.taxTNCN;

        html += `
            <div class="card summary-card">
                <div class="card-header">
                    <span>üìä T·ªîNG H·ª¢P TO√ÄN B·ªò (T·∫•t c·∫£ c√°c th√°ng)</span>
                </div>
                <div class="card-body">
                    <div class="metric-row">
                        <span class="metric-label">T·ªïng doanh thu quy·∫øt to√°n:</span>
                        <span class="metric-value val-revenue">${formatCurrency(grandTotal.settlementRevenue)}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">T·ªïng S·ªë ti·ªÅn h√†ng b√°n tr·∫£ l·∫°i:</span>
                        <span class="metric-value val-refund">${formatCurrency(grandTotal.refundAmount)}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">(T·ªïng) S·ªë ti·ªÅn quy·∫øt to√°n:</span>
                        <span class="metric-value val-settlement">${formatCurrency(grandTotal.totalSettlement)}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">(T·ªïng) Ph√≠ Affiliate:</span>
                        <span class="metric-value">${formatCurrency(grandTotal.affiliateFee)}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">(T·ªïng) Thu·∫ø GTGT:</span>
                        <span class="metric-value">${formatCurrency(grandTotal.taxGTGT)}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">(T·ªïng) Thu·∫ø TNCN:</span>
                        <span class="metric-value">${formatCurrency(grandTotal.taxTNCN)}</span>
                    </div>
                    
                    <div class="metric-row" style="background-color: #e3f2fd; margin: 10px -20px -15px -20px; padding: 15px 20px; border-top: 1px solid #bbdefb;">
                        <span class="metric-label" style="font-weight:bold; color:#0d47a1;">(T·ªïng) Chi ph√≠ n·ªÅn t·∫£ng:</span>
                        <span class="metric-value val-platform" style="font-size:1.2em;">${formatCurrency(grandPlatformFee)}</span>
                    </div>
                </div>
            </div>
            
            <div class="section-title">CHI TI·∫æT THEO TH√ÅNG</div>
        `;

        // --- Render Chi Ti·∫øt C√°c Th√°ng ---
        const sortedKeys = Object.keys(results).sort((a, b) => {
            const [mA, yA] = a.replace('Th√°ng ', '').split('/').map(Number);
            const [mB, yB] = b.replace('Th√°ng ', '').split('/').map(Number);
            if (yA !== yB) return yA - yB;
            return mA - mB;
        });

        if (sortedKeys.length === 0) {
            outputDiv.innerHTML = '<div style="text-align:center; padding:20px;">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p.</div>';
            return;
        }

        sortedKeys.forEach(key => {
            const data = results[key];
            const platformFee = data.settlementRevenue - data.totalSettlement + data.affiliateFee + data.taxGTGT + data.taxTNCN;

            html += `
                <div class="card">
                    <div class="card-header">
                        <span>üóìÔ∏è ${key}</span>
                    </div>
                    <div class="card-body">
                        <div class="metric-row">
                            <span class="metric-label">Doanh thu quy·∫øt to√°n:</span>
                            <span class="metric-value val-revenue">${formatCurrency(data.settlementRevenue)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">S·ªë ti·ªÅn h√†ng b√°n tr·∫£ l·∫°i:</span>
                            <span class="metric-value val-refund">${formatCurrency(data.refundAmount)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">S·ªë ti·ªÅn quy·∫øt to√°n:</span>
                            <span class="metric-value val-settlement">${formatCurrency(data.totalSettlement)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Ph√≠ Affiliate:</span>
                            <span class="metric-value">${formatCurrency(data.affiliateFee)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Thu·∫ø GTGT:</span>
                            <span class="metric-value">${formatCurrency(data.taxGTGT)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Thu·∫ø TNCN:</span>
                            <span class="metric-value">${formatCurrency(data.taxTNCN)}</span>
                        </div>
                        <div class="metric-row" style="background-color: #fff8e1; margin: 10px -20px -15px -20px; padding: 15px 20px; border-top: 1px solid #ffe0b2;">
                            <span class="metric-label" style="font-weight:600;">Chi ph√≠ n·ªÅn t·∫£ng:</span>
                            <span class="metric-value val-platform">${formatCurrency(platformFee)}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        outputDiv.innerHTML = html;
    };

    // Events
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) processFile(e.target.files[0]);
        e.target.value = ''; 
    });

    dropZone.addEventListener('click', (e) => {
        fileInput.click();
    });

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#ee4d2d';
        dropZone.style.backgroundColor = '#fff5f2';
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#bdc3c7';
        dropZone.style.backgroundColor = '#fafafa';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#bdc3c7';
        dropZone.style.backgroundColor = '#fafafa';
        if (e.dataTransfer.files.length > 0) {
            processFile(e.dataTransfer.files[0]);
        }
    });
</script>

</body>
</html>