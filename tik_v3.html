<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Shop Analyzer (V6 - Export)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #fe2c55; /* TikTok Red */
            --secondary: #25f4ee; /* TikTok Cyan */
            --dark: #121212;
            --bg: #f8f9fa;
            --text: #333;
            --card-bg: #fff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1100px; margin: 0 auto; }

        /* Header */
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { margin: 0; font-size: 2em; }
        .header h1 span { color: var(--primary); }

        /* Upload Area */
        .upload-container {
            background: var(--card-bg); border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 30px;
            text-align: center; margin-bottom: 20px;
        }
        .drop-zone {
            border: 2px dashed #cbd5e1; border-radius: 8px; padding: 30px;
            background: #f8fafc; cursor: pointer; transition: all 0.2s;
        }
        .drop-zone:hover { border-color: var(--primary); background: #fff0f3; }
        .btn-upload {
            background: var(--dark); color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            margin-top: 15px; font-weight: 600;
        }

        /* Menu Selection */
        #menu-selection { display: none; text-align: center; margin: 30px 0; }
        .btn-choice {
            padding: 20px 40px; border-radius: 12px; border: none; cursor: pointer;
            font-size: 1.1em; font-weight: bold; margin: 0 15px;
            transition: transform 0.2s, box-shadow 0.2s; display: inline-flex;
            flex-direction: column; align-items: center; width: 220px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-choice:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
        .btn-cost { background: #e0f2f1; color: #00695c; border: 2px solid #00695c; }
        .btn-order { background: #e3f2fd; color: #1565c0; border: 2px solid #1565c0; }
        .icon-btn { font-size: 32px; margin-bottom: 10px; }

        /* Results Area */
        #results-container { display: none; }
        .back-btn {
            background: transparent; border: 1px solid #ccc; color: #666;
            padding: 8px 15px; border-radius: 4px; cursor: pointer;
            margin-bottom: 20px; font-size: 0.9em;
        }
        .back-btn:hover { background: #eee; }

        /* Order Styles */
        .month-block { margin-bottom: 40px; border: 1px solid #e0e0e0; border-radius: 8px; background: white; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .month-title { 
            background: #333; color: white; padding: 12px 20px; 
            font-size: 1.2em; font-weight: bold; 
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .order-group { padding: 20px; border-bottom: 4px solid #f4f4f4; }
        .order-group:last-child { border-bottom: none; }
        
        .group-header { 
            font-size: 1.1em; font-weight: bold; margin-bottom: 15px; 
            display: flex; align-items: center; justify-content: space-between;
        }
        .badge { padding: 4px 10px; border-radius: 20px; color: white; font-size: 0.8em; margin-right: 10px; min-width: 30px; text-align: center;}
        
        .bg-normal { background: #4CAF50; }
        .bg-cancel { background: #FF9800; }
        .bg-bom { background: #9C27B0; }
        .bg-return { background: #F44336; }

        .table-responsive { overflow-x: auto; max-height: 400px; overflow-y: auto; border: 1px solid #eee; }
        table.order-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        table.order-table th { background: #f8f9fa; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; color: #555; position: sticky; top: 0; }
        table.order-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .num-cell { font-family: monospace; text-align: right; font-weight: 500; }

        /* Action Buttons */
        .action-group { display: flex; gap: 10px; }
        .btn-mini {
            border: 1px solid #ccc; background: white; padding: 4px 10px;
            border-radius: 4px; font-size: 0.8em; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .btn-mini:hover { background: #f5f5f5; border-color: #999; }
        .btn-copy { color: #1565c0; }
        .btn-down { color: #2e7d32; }

        /* Compact Normal Order View */
        .normal-summary {
            background: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .normal-count { font-size: 1.5em; color: #2e7d32; font-weight: bold; }

        /* Cost Styles */
        .cost-card { background: #fff; border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px; overflow: hidden; }
        .cost-header { background: #f1f1f1; padding: 10px 15px; font-weight: bold; }
        .cost-body { padding: 10px 15px; }
        .metric-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .val { font-family: monospace; font-weight: bold; }
        .hl-platform { color: #ea580c; font-size: 1.1em; }
        .summary-card { border: 2px solid var(--secondary); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>TikTok Shop <span>Analyzer V6</span></h1>
    </div>

    <div class="upload-container" id="upload-step">
        <div class="drop-zone" id="drop-zone">
            <div style="font-size: 40px;">üìÇ</div>
            <p>K√©o th·∫£ file <b>Order details</b> (.xlsx, .csv) v√†o ƒë√¢y</p>
            <button class="btn-upload" onclick="document.getElementById('fileInput').click()">Ch·ªçn File</button>
            <input type="file" id="fileInput" accept=".xlsx, .csv" style="display:none">
        </div>
    </div>

    <div id="menu-selection">
        <button class="btn-choice btn-order" onclick="runAnalysis('ORDER')">
            <span class="icon-btn">üì¶</span>
            Ph√¢n t√≠ch<br>ƒê∆°n h√†ng
        </button>
        <button class="btn-choice btn-cost" onclick="runAnalysis('COST')">
            <span class="icon-btn">üí∞</span>
            Ph√¢n t√≠ch<br>Chi ph√≠
        </button>
    </div>

    <div id="results-container">
        <button class="back-btn" onclick="resetView()">‚Üê Quay l·∫°i Menu</button>
        <div id="results-content"></div>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH ---
    const KEYWORDS = {
        ORDER_ID: ["order", "id"], TYPE: ["type"], CREATED_TIME: ["created time"],
        REVENUE: ["total revenue"], SETTLEMENT: ["settlement amount"], TOTAL_FEES: ["total fees"],
        VAT: ["vat withheld"], PIT: ["pit withheld"], ADJUSTMENT: ["ajustment amount", "adjustment amount"],
        REFUND_SUB_SELLER: ["refund subtotal after seller"],
        AFF_COMMISSION: ["affiliate commission"], AFF_SHOP_ADS: ["affiliate shop ads"],
        AFF_PARTNER: ["affiliate partner commission"], AFF_PARTNER_ADS: ["affiliate partner shop ads"]
    };

    let GLOBAL_DATA = { rawData: [], map: {} };
    const fmt = (n) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n);

    // --- EVENTS ---
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', (e) => { if(e.target.files.length) handleFile(e.target.files[0]); e.target.value = ''; });
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.background = '#e3f2fd'; });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.background = '#f8fafc'; if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });

    // --- X·ª¨ L√ù FILE ---
    function handleFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                processWorkbook(workbook);
            } catch (err) { alert("L·ªói ƒë·ªçc file: " + err.message); }
        };
        reader.readAsArrayBuffer(file);
    }

    function updateSheetRange(ws) {
        let range = { s: { r: 10000000, c: 10000000 }, e: { r: 0, c: 0 } };
        let hasCell = false;
        Object.keys(ws).forEach(x => {
            if (x.charAt(0) === '!') return;
            hasCell = true;
            const cell = XLSX.utils.decode_cell(x);
            range.s.r = Math.min(range.s.r, cell.r);
            range.s.c = Math.min(range.s.c, cell.c);
            range.e.r = Math.max(range.e.r, cell.r);
            range.e.c = Math.max(range.e.c, cell.c);
        });
        if (hasCell) ws['!ref'] = XLSX.utils.encode_range(range);
    }

    function processWorkbook(workbook) {
        let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes("order details") || n.toLowerCase().includes("chi ti·∫øt"));
        if (!sheetName) sheetName = workbook.SheetNames[0]; 
        const ws = workbook.Sheets[sheetName];
        updateSheetRange(ws);
        const rawData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
        if (rawData.length < 2) { alert("File tr·ªëng!"); return; }

        const map = findColumnMapping(rawData);
        if (map.headerRow === -1) { alert("L·ªói Header!"); return; }

        GLOBAL_DATA.rawData = rawData;
        GLOBAL_DATA.map = map;
        document.getElementById('upload-step').style.display = 'none';
        document.getElementById('menu-selection').style.display = 'block';
    }

    function findColumnMapping(rows) {
        let mapping = { headerRow: -1, cols: {} };
        for (let i = 0; i < Math.min(rows.length, 100); i++) {
            const row = rows[i].map(c => String(c).toLowerCase().trim());
            if (row.some(c => c.includes("total revenue") || c === "revenue")) {
                mapping.headerRow = i;
                const findIdx = (kws) => row.findIndex(cell => kws.some(k => cell.includes(k)));
                mapping.cols = {
                    ORDER_ID: findIdx(KEYWORDS.ORDER_ID), TYPE: findIdx(KEYWORDS.TYPE),
                    CREATED_TIME: findIdx(KEYWORDS.CREATED_TIME), REVENUE: findIdx(KEYWORDS.REVENUE),
                    SETTLEMENT: findIdx(KEYWORDS.SETTLEMENT), TOTAL_FEES: findIdx(KEYWORDS.TOTAL_FEES),
                    VAT: findIdx(KEYWORDS.VAT), PIT: findIdx(KEYWORDS.PIT), ADJUSTMENT: findIdx(KEYWORDS.ADJUSTMENT),
                    REFUND_SUB_SELLER: findIdx(KEYWORDS.REFUND_SUB_SELLER),
                    AFF_COMMISSION: row.findIndex(c => c === "affiliate commission"),
                    AFF_SHOP_ADS: row.findIndex(c => c.includes("affiliate shop ads") && !c.includes("pit")),
                    AFF_PARTNER: findIdx(KEYWORDS.AFF_PARTNER), AFF_PARTNER_ADS: findIdx(KEYWORDS.AFF_PARTNER_ADS)
                };
                break;
            }
        }
        return mapping;
    }

    function parseNum(val) {
        if (typeof val === 'number') return val;
        if (!val) return 0;
        if (typeof val === 'string') {
            const clean = val.replace(/,/g, '').trim(); 
            const num = parseFloat(clean);
            return isNaN(num) ? 0 : num;
        }
        return 0;
    }

    function runAnalysis(mode) {
        document.getElementById('menu-selection').style.display = 'none';
        document.getElementById('results-container').style.display = 'block';
        const content = document.getElementById('results-content');
        content.innerHTML = '<p style="text-align:center; padding:20px;">‚è≥ ƒêang t√≠nh to√°n...</p>';
        setTimeout(() => { mode === 'COST' ? analyzeCost(content) : analyzeOrder(content); }, 50);
    }
    function resetView() {
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('menu-selection').style.display = 'block';
    }

    // --- PH√ÇN T√çCH CHI PH√ç (COST) ---
    function analyzeCost(container) {
        const rows = GLOBAL_DATA.rawData; const map = GLOBAL_DATA.map;
        const results = {}; const total = { revenue:0, settlement:0, refund:0, affiliate:0, vat:0, pit:0, platform:0, ads:0 };

        for (let i = map.headerRow + 1; i < rows.length; i++) {
            const row = rows[i];
            let dateVal = row[map.cols.CREATED_TIME];
            if (!dateVal) continue;
            let dateObj = (typeof dateVal === 'number') ? XLSX.SSF.parse_date_code(dateVal) : new Date(dateVal);
            if (isNaN(dateObj.getTime())) continue;

            const monthKey = `Th√°ng ${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;
            const rev = parseNum(row[map.cols.REVENUE]);
            const settle = parseNum(row[map.cols.SETTLEMENT]);
            const fees = parseNum(row[map.cols.TOTAL_FEES]);
            const vat = parseNum(row[map.cols.VAT]);
            const pit = parseNum(row[map.cols.PIT]);
            const ads = parseNum(row[map.cols.ADJUSTMENT]);
            let aff = 0;
            if (map.cols.AFF_COMMISSION > -1) aff += parseNum(row[map.cols.AFF_COMMISSION]);
            if (map.cols.AFF_SHOP_ADS > -1) aff += parseNum(row[map.cols.AFF_SHOP_ADS]);
            if (map.cols.AFF_PARTNER > -1) aff += parseNum(row[map.cols.AFF_PARTNER]);
            if (map.cols.AFF_PARTNER_ADS > -1) aff += parseNum(row[map.cols.AFF_PARTNER_ADS]);

            const refund = rev < 0 ? rev : 0;
            const platform = fees - aff - vat - pit;

            if (!results[monthKey]) results[monthKey] = { revenue:0, settlement:0, refund:0, affiliate:0, vat:0, pit:0, platform:0, ads:0 };
            const m = results[monthKey];
            m.revenue += rev; m.settlement += settle; m.refund += refund; m.affiliate += aff; 
            m.vat += vat; m.pit += pit; m.platform += platform; m.ads += ads;
            total.revenue += rev; total.settlement += settle; total.refund += refund; total.affiliate += aff;
            total.vat += vat; total.pit += pit; total.platform += platform; total.ads += ads;
        }

        let html = '';
        const renderCard = (title, d, isSum=false) => `
            <div class="cost-card ${isSum?'summary-card':''}" style="${isSum ? 'border:2px solid var(--secondary)' : ''}">
                <div class="cost-header" style="${isSum ? 'background:#e0fcfb; color:#00695c' : ''}">${title}</div>
                <div class="cost-body">
                    <div class="metric-row"><span class="label">Doanh thu quy·∫øt to√°n</span><span class="val" style="color:#2196F3">${fmt(d.revenue)}</span></div>
                    <div class="metric-row"><span class="label">S·ªë ti·ªÅn quy·∫øt to√°n</span><span class="val" style="color:#4CAF50">${fmt(d.settlement)}</span></div>
                    <div class="metric-row"><span class="label">Ph√≠ Affiliate</span><span class="val">${fmt(d.affiliate)}</span></div>
                    <div class="metric-row"><span class="label">Thu·∫ø GTGT</span><span class="val">${fmt(d.vat)}</span></div>
                    <div class="metric-row"><span class="label">Thu·∫ø TNCN</span><span class="val">${fmt(d.pit)}</span></div>
                    <div class="metric-row"><span class="label">Ph√≠ Qu·∫£ng c√°o</span><span class="val" style="color:#9C27B0">${fmt(d.ads)}</span></div>
                    <div class="metric-row" style="background:#fff3e0; margin-bottom:-10px; border-top:1px solid #ffe0b2; padding:12px 0;">
                        <span class="label" style="font-weight:bold; color:#e65100">Chi ph√≠ n·ªÅn t·∫£ng</span>
                        <span class="val hl-platform">${fmt(d.platform)}</span>
                    </div>
                </div>
            </div>`;

        html += renderCard("üìä T·ªîNG H·ª¢P TO√ÄN B·ªò", total, true);
        const sorted = Object.keys(results).sort((a,b) => {
            const [mA, yA] = a.replace("Th√°ng ","").split("/").map(Number);
            const [mB, yB] = b.replace("Th√°ng ","").split("/").map(Number);
            return yA - yB || mA - mB;
        });
        html += `<h3 style="text-align:center; color:#666; margin:30px 0;">--- CHI TI·∫æT THEO TH√ÅNG ---</h3>`;
        sorted.forEach(k => html += renderCard(k, results[k]));
        container.innerHTML = html;
    }

    // --- PH√ÇN T√çCH ƒê∆†N H√ÄNG (ORDER) ---
    function analyzeOrder(container) {
        const rows = GLOBAL_DATA.rawData; const map = GLOBAL_DATA.map;
        if (map.cols.REFUND_SUB_SELLER === -1) { container.innerHTML = `<p style="color:red">Thi·∫øu c·ªôt 'Refund subtotal after seller discounts'.</p>`; return; }
        const dataByMonth = {};

        for (let i = map.headerRow + 1; i < rows.length; i++) {
            const row = rows[i];
            console.log("X·ª≠ l√Ω:", row[map.cols.ORDER_ID]);
            let typeVal = (map.cols.TYPE > -1) ? row[map.cols.TYPE] : "Order"; 
            if (map.cols.TYPE > -1 && String(typeVal).trim() !== "Order") {
              console.log("B·ªè do l·ªói type:", row);
              continue;
            }

            let dateVal = row[map.cols.CREATED_TIME];
            if (!dateVal) {
              console.log("B·ªè do l·ªói date:", row);
              continue;
            }
            let dateObj = (typeof dateVal === 'number') ? XLSX.SSF.parse_date_code(dateVal) : new Date(dateVal);
            if (isNaN(dateObj.getTime())) {
                console.log("B·ªè do l·ªói date:", row);
                continue;
            }
            // if (isNaN(dateObj.getTime())) continue;
            

            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            const dateStr = `${day}/${month}/${year}`;
            const monthKey = `Th√°ng ${month}/${year}`;

            if (!dataByMonth[monthKey]) dataByMonth[monthKey] = { normal: [], cancel: [], bom: [], return: [] };

            const item = { 
                id: row[map.cols.ORDER_ID], 
                date: dateStr, 
                settle: parseNum(row[map.cols.SETTLEMENT]), 
                refund: parseNum(row[map.cols.REFUND_SUB_SELLER]) 
            };

            if (item.settle > 0) dataByMonth[monthKey].normal.push(item);
            else if (item.settle === 0 && item.refund < 0) dataByMonth[monthKey].cancel.push(item);
            else if (item.settle < 0 && item.refund === 0) dataByMonth[monthKey].bom.push(item);
            else if (item.settle < 0 && item.refund < 0) dataByMonth[monthKey].return.push(item);
            else {
                console.log("Kh√¥ng ph√¢n lo·∫°i ƒë∆∞·ª£c:", item);
            }
        }

        let html = '';
        const sorted = Object.keys(dataByMonth).sort((a,b) => {
            const [mA, yA] = a.replace("Th√°ng ","").split("/").map(Number);
            const [mB, yB] = b.replace("Th√°ng ","").split("/").map(Number);
            return yA - yB || mA - mB;
        });

        if (sorted.length === 0) html = '<p style="text-align:center;">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng Type="Order".</p>';

        sorted.forEach(mKey => {
            const grp = dataByMonth[mKey];
            const totalOrders = grp.normal.length + grp.cancel.length + grp.bom.length + grp.return.length;
            
            html += `<div class="month-block">
                <div class="month-title">
                    <span>${mKey}</span>
                    <span style="background:rgba(255,255,255,0.2); padding:2px 10px; border-radius:12px; font-size:0.8em">T·ªïng: ${totalOrders} ƒë∆°n</span>
                </div>`;
            
            // 1. ƒê∆°n B√¨nh th∆∞·ªùng: Ch·ªâ hi·ªán s·ªë l∆∞·ª£ng + Download
            html += `<div class="order-group">
                <div class="group-header">
                    <div style="display:flex; align-items:center;">
                        <span class="badge bg-normal">${grp.normal.length}</span> ƒê∆°n th√†nh c√¥ng (B√¨nh th∆∞·ªùng)
                    </div>
                    <div class="action-group">
                         <button class="btn-mini btn-down" onclick='downloadEXCEL(${JSON.stringify(grp.normal)}, "${mKey}_Normal")'>‚¨á Excel</button>
                    </div>
                </div>
                ${grp.normal.length > 0 ? 
                    `<div class="normal-summary">
                        <div>ƒê√£ ·∫©n danh s√°ch chi ti·∫øt ƒë·ªÉ g·ªçn giao di·ªán.</div>
                        <div class="normal-count">+${grp.normal.length} ƒë∆°n</div>
                    </div>` 
                    : '<div style="color:#999; font-style:italic;">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>'}
            </div>`;

            // Helper render table
            const renderTable = (title, items, badge, nameSuffix) => {
                const tableId = `tbl_${mKey.replace(/[^a-zA-Z0-9]/g,'')}_${nameSuffix}`;
                let s = `<div class="order-group">
                    <div class="group-header">
                        <div style="display:flex; align-items:center;">
                            <span class="badge ${badge}">${items.length}</span> ${title}
                        </div>
                        ${items.length > 0 ? `
                        <div class="action-group">
                            <button class="btn-mini btn-copy" onclick="copyTable('${tableId}')">üìã Copy</button>
                            <button class="btn-mini btn-down" onclick='downloadEXCEL(${JSON.stringify(items)}, "${mKey}_${nameSuffix}")'>‚¨á Excel</button>
                        </div>` : ''}
                    </div>`;
                
                if (items.length === 0) s += `<div style="color:#999; font-style:italic;">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>`;
                else {
                    s += `<div class="table-responsive"><table class="order-table" id="${tableId}">
                        <thead><tr><th>M√£ ƒë∆°n h√†ng</th><th>Ng√†y t·∫°o</th><th>Ti·ªÅn quy·∫øt to√°n</th><th>Ho√†n l·∫°i</th></tr></thead>
                        <tbody>`;
                    items.forEach(it => {
                        s += `<tr><td style="mso-number-format:'\\@';">${it.id}</td><td>${it.date}</td><td class="num-cell" style="color:${it.settle>0?'green':'red'}">${fmt(it.settle)}</td><td class="num-cell">${fmt(it.refund)}</td></tr>`;
                    });
                    s += `</tbody></table></div>`;
                }
                s += `</div>`;
                return s;
            };

            html += renderTable("ƒê∆°n h·ªßy (Thanh to√°n tr∆∞·ªõc nh∆∞ng h·ªßy)", grp.cancel, "bg-cancel", "Cancel");
            html += renderTable("ƒê∆°n Bom / H√†ng m·∫´u (Settle < 0, Refund = 0)", grp.bom, "bg-bom", "Bom");
            html += renderTable("ƒê∆°n Ho√†n tr·∫£ (C·∫ßn theo d√µi)", grp.return, "bg-return", "Return");
            html += `</div>`;
        });
        container.innerHTML = html;
    }

    // --- EXPORT TOOLS ---
    function copyTable(tableId) {
        const el = document.getElementById(tableId);
        if(!el) return;
        const range = document.createRange();
        range.selectNode(el);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand('copy');
        window.getSelection().removeAllRanges();
        alert("ƒê√£ sao ch√©p b·∫£ng!");
    }

    function downloadCSV(data, filename) {
        if(!data || data.length === 0) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i"); return; }
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM
        csvContent += "M√£ ƒë∆°n h√†ng,Ng√†y t·∫°o,Ti·ªÅn quy·∫øt to√°n,Ti·ªÅn ho√†n l·∫°i\n";
        data.forEach(row => {
            csvContent += `'${row.id},${row.date},${row.settle},${row.refund}\n`;
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `TikTok_${filename}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function downloadEXCEL(data, filename) {
        if (!data || data.length === 0) {
            alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i");
            return;
        }

        // 1. Chu·∫©n b·ªã d·ªØ li·ªáu v·ªõi ti√™u ƒë·ªÅ c·ªôt ti·∫øng Vi·ªát
        const excelData = data.map(row => ({
            "M√£ ƒë∆°n h√†ng": row.id,
            "Ng√†y t·∫°o": row.date,
            "Ti·ªÅn quy·∫øt to√°n": row.settle,
            "Ti·ªÅn ho√†n l·∫°i": row.refund
        }));

        // 2. T·∫°o m·ªôt Worksheet m·ªõi t·ª´ m·∫£ng d·ªØ li·ªáu
        const worksheet = XLSX.utils.json_to_sheet(excelData);

        // 3. T·ª± ƒë·ªông cƒÉn ch·ªânh ƒë·ªô r·ªông c·ªôt (Optional nh∆∞ng n√™n c√≥)
        const wscols = [
            { wch: 25 }, // ƒê·ªô r·ªông c·ªôt M√£ ƒë∆°n h√†ng
            { wch: 15 }, // ƒê·ªô r·ªông c·ªôt Ng√†y t·∫°o
            { wch: 20 }, // ƒê·ªô r·ªông c·ªôt Ti·ªÅn quy·∫øt to√°n
            { wch: 20 }  // ƒê·ªô r·ªông c·ªôt Ti·ªÅn ho√†n l·∫°i
        ];
        worksheet['!cols'] = wscols;

        // 4. T·∫°o m·ªôt Workbook (file Excel) v√† th√™m Worksheet v√†o
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Data");

        // 5. Xu·∫•t file v√† k√≠ch ho·∫°t tr√¨nh duy·ªát t·∫£i v·ªÅ
        // Th∆∞ vi·ªán XLSX s·∫Ω t·ª± x·ª≠ l√Ω vi·ªác t·∫°o Blob v√† link t·∫£i
        XLSX.writeFile(workbook, `TikTok_${filename}.xlsx`);
    }
</script>

</body>
</html>